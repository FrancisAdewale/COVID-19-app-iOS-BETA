#!/usr/bin/env -S ruby -E UTF-8:UTF-8

github_token = ENV.fetch("GITHUB_TOKEN")

require 'bundler/inline'
gemfile do
  gem 'sonar-ci-tools', git: "https://#{github_token}:x-oauth-basic@github.com/nhsx/sonar-ci-tools"
end
puts 'Gems loaded'
puts

require "updates_tracker_stories_with_build_number"
include UpdatesTrackerStoriesWithBuildNumber

rev_list = ARGV.shift

update_stories_with_build_number(
  build_number: ENV.fetch("BUILD"),
  tracker_token: ENV.fetch("PIVOTAL_TRACKER_API_TOKEN"),
  commits: rev_list,
  message_template: 'This story was included in build %{build_number}',
  git_dir: File.expand_path("..", __dir__),
)
