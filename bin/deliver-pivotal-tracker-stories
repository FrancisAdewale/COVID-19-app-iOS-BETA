#!/usr/bin/env bash

set -e

# collect commits that have been changed
commits=$(git rev-list last-commit-to-run-on-ci..HEAD)

find_finished_stories() {
  echo "$commits" \
    | xargs git log --format=%B -n 1 \
    | grep "\[Finishes #" \
    | sed 's/\[Finishes #\([0-9]*\)\]/\1/' \
    | sed -e 's/^[ \t]*//'
}

story_ids=$(find_finished_stories)

echo "Running with these commits : $commits -- and these story ids : $story_ids"

# get the current testflight build
PLIST=Sonar/Info.plist
current_version=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$PLIST")

# iterate over stories and comment on each one
for STORY_ID in $story_ids
do
  POST_BODY="{\"text\": \"This was delivered in TestFlight build $current_version\"}"
  URL="https://www.pivotaltracker.com/services/v5/projects/$PROJECT_ID/stories/$STORY_ID/comments"

  curl -X POST -H "X-TrackerToken: $PIVOTAL_TRACKER_API_TOKEN" -H "Content-Type: application/json" -d "$POST_BODY" "$URL" --fail
done

